<html>
<head>
    <link rel="stylesheet" href="/libs/bootstrap.min.css">
    <script type="text/javascript" src="/libs/bootstrap-native-v4.min.js"></script>
    <script type="text/javascript" src="/libs/app.js"></script>
    <script type="text/javascript">
        'use strict';

        // Default Fetch Options
        var defaultFetchOptions = {
            headers: [
                [ 'Accept', 'application/json' ],
                [ 'Content-Type', 'application/json' ],
                [ 'Authorization', '' ]
            ]
        };
        $$.SetDefaultFetchOptions(defaultFetchOptions);

        // Manage Forms
        function onSubmit(form, callback) {
            var btn, prevInnerHTML;
            var data = {};
            for (var i = 0; i < form.length; ++i) {
                var element = form[i];
                if (element.type === "submit") {
                    btn = element;
                    if (btn.innerHTML === 'Loading...') return false;
                    prevInnerHTML = btn.innerHTML;
                    btn.innerHTML = 'Loading...';
                    // TODO: Disable Submit Button
                } else if (element.name) {
                    if (element.type === "checkbox") {
                        data[element.name] = (element.value === "on");
                    } else if (element.value !== "") {
                        var numValue = element.value * 1;
                        data[element.name] = (element.value == numValue) ? numValue : element.value;
                    }
                }
            }
            $$.Fetch(form.action.substr(form.action.indexOf('#') + 1), $$.OverrideDefaultFetchOptions({
                data: data,
                onSuccess: !callback ? null : function(xhr) {
                    callback(JSON.parse(xhr.response));
                },
                onFailure: function(xhr, uri) {
                    console.log(uri + " :: failure :: " + xhr.response);
                },
                onComplete: function() {
                    if (btn) {
                        btn.innerHTML = prevInnerHTML;
                        // TODO: Enable Submit Button
                    }
                }
            }));
            return false;
        }

        // Handle Polling
        function onPoll(response) {
            document.getElementById('stdout').innerHTML += response['out'];
            document.getElementById('stderr').innerHTML += response['err'];
        }

        // Auto-Polling
        var polls = {};
        function polling(checkbox, id) {
            if ((checkbox == null || checkbox.checked) && !polls[id]) {
                // Poll Loop
                polls[id] = $$.Fetch('/poll', $$.OverrideDefaultFetchOptions({
                    data: { pollId: id },
                    onSuccess: function(xhr) {
                        onPoll(JSON.parse(xhr.response))
                    },
                    onFailure: function(xhr) {
                        if (polls[id] === false) return;
                        console.log("polling failure :: " + xhr.response);
                    },
                    onComplete: function() {
                        if (polls[id] === false) return;
                        polls[id] = null;
                        polling(checkbox, id);
                    }
                }));
            } else if (polls[id]) {
                // Abort
                var poll = polls[id];
                polls[id] = false;
                poll.abort();
            }
        }

        // Handle Login
        function onLogin(response) {
            defaultFetchOptions.headers[2] = [ 'Authorization', 'Bearer ' + response['token'] ];
            $$.SetDefaultFetchOptions(defaultFetchOptions);

            var html = '';
            response['hosts'].forEach(function(value, id){
                if (value.autoPoll) {
                    polling(null, id);
                    html += '<input type="checkbox" checked="checked" onchange="polling(this, ' + id + ')"> ' + value.host + '<br>';
                } else {
                    html += '<input type="checkbox" onchange="polling(this, ' + id + ')"> ' + value.host + '<br>';
                }
            });
            document.getElementById('hosts').innerHTML = html;
        }
    </script>
</head>
<body>
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <form id="login" action="#/login" onsubmit="return onSubmit(this, onLogin)">
                    <div class="form-group">
                        <label for="loginUsername">Username</label>
                        <input type="text" class="form-control" id="loginUsername" name="username" placeholder="Username" value="admin">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password</label>
                        <input type="password" class="form-control" id="loginPassword" name="password" placeholder="Password" value="admin">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        Login
                    </button>
                </form>
            </div>
            <div class="col">
                <form id="addhost" action="#/addhost" onsubmit="return onSubmit(this)">
                    <div class="form-group">
                        <label for="host">Host</label>
                        <input type="text" class="form-control" id="host" name="host" placeholder="Host" value="cloud02.calebgray.com:22">
                    </div>
                    <div class="form-group">
                        <label for="addhostUsername">Username</label>
                        <input type="text" class="form-control" id="addhostUsername" name="username" placeholder="Username" value="root">
                    </div>
                    <div class="form-group">
                        <label for="addhostPassword">Password</label>
                        <input type="password" class="form-control" id="addhostPassword" name="password" placeholder="Password">
                    </div>
                    <div class="form-group">
                        <label for="publicKey">Public Key</label>
                        <input type="text" class="form-control" id="publicKey" name="publicKey" placeholder="Public Key">
                    </div>
                    <div class="form-group">
                        <input type="checkbox" class="form-control" id="autoConnect" name="autoConnect" checked="checked">
                        <label for="autoConnect">Automatically Connect</label>
                    </div>
                    <div class="form-group">
                        <input type="checkbox" class="form-control" id="autoPoll" name="autoPoll" checked="checked">
                        <label for="autoPoll">Automatically Poll</label>
                    </div>
                    <button type="submit" class="btn btn-primary">
                        Add Host
                    </button>
                </form>
            </div>
            <div class="col">
                <form id="execute" action="#/execute" onsubmit="return onSubmit(this)">
                    <div class="form-group">
                        <label for="executeId">Id</label>
                        <input type="text" class="form-control" id="executeId" name="id" placeholder="Id" value="0">
                    </div>
                    <div class="form-group">
                        <label for="executeCommand">Command</label>
                        <input type="text" class="form-control" id="executeCommand" name="command" placeholder="Command" value="ls">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        Execute
                    </button>
                </form>
            </div>
            <div class="col">
                <form id="poll" action="#/poll" onsubmit="return onSubmit(this, onPoll)">
                    <div class="form-group">
                        <label for="pollId">Id</label>
                        <input type="text" class="form-control" id="pollId" name="id" placeholder="Id" value="0">
                    </div>
                    <button type="submit" class="btn btn-primary">
                        Poll
                    </button>
                </form>
            </div>
        </div>
        <div class="row">
            <div class="col">
                <div id="hosts"></div>
            </div>
            <div class="col">
                <pre id="stdout"></pre>
            </div>
            <div class="col">
                <pre id="stderr"></pre>
            </div>
        </div>
    </div>
</body>
</html>